<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://pixijs.download/release/pixi.js"></script>
    <title>dragging</title>
  </head>
  <body>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // サーバーへ接続
      const socket = io();

      //pixi
      const app = new PIXI.Application({ background: '#96C78C', resizeTo: window });
      document.body.appendChild(app.view);

      const texture = PIXI.Texture.from('https://stickershop.line-scdn.net/stickershop/v1/product/21802595/LINEStorePC/main.png?v=1');
      texture.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;

      for (let i = 0; i < 3; i++){
        createBunny((0.5 * i * app.screen.width),(0.5 * i * app.screen.height));
      }

      let dragTarget = null;

      app.stage.eventMode = 'static';
      app.stage.hitArea = app.screen;
      app.stage.on('pointerup', onDragEnd);
      app.stage.on('pointerupoutside', onDragEnd);

      io.on("connection", (socket) => {
        // イベントが送られてきたら以下を実行
        //移動した後の真ん中のbunnyの座標をget
        var bunnyx = bunny[1].getBoundingClientRect().x;
        var bunnyy = bunny[1].getBoundingClientRect().y;

        // socketに送信
        socket.emit('pointermove', (bunnyx, bunnyy));

        // socketから受信
        socket.on('bunnyreceive', (bunnyx, bunnyy) => {
          createBunny(bunnyx, bunnyy);
        });

      });

      function createBunny(x, y){
        const bunny = new PIXI.Sprite(texture);
        bunny.eventMode = 'static';
        bunny.cursor = 'pointer';
        bunny.anchor.set(0.5);
        bunny.scale.set(0.8);

        // setup events for mouse + touch using
        // the pointer events
        bunny.on('pointerdown', onDragStart, bunny);

        // move the sprite to its designated position
        bunny.x = x;
        bunny.y = y;

        // add it to the stage
        app.stage.addChild(bunny);
      }

      function onDragMove(event){
        if (dragTarget){
            dragTarget.parent.toLocal(event.global, null, dragTarget.position);
        }
      }

      function onDragStart(){
        this.alpha = 0.5;
        dragTarget = this;
        app.stage.on('pointermove', onDragMove);
      }

      function onDragEnd(){
        if (dragTarget){
          app.stage.off('pointermove', onDragMove);
          dragTarget.alpha = 1;
          dragTarget = null;
        }
      }

    </script>
  </body>
</html>